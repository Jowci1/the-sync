<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE SYNC</title>

    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://the-sync.vercel.app/icon.png" />
    <meta property="fc:frame:button:1" content="PLAY THE SYNC" />
    <meta property="fc:frame:button:1:action" content="link" />
    <meta property="fc:frame:button:1:target" content="https://the-sync.vercel.app" />

    <style>
        body { margin: 0; background-color: black; color: #00ffff; font-family: 'Courier New', Courier, monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; touch-action: none; }
        #ui { text-align: center; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        h1 { font-size: 2.5rem; text-shadow: 0 0 10px #00ffff; margin: 0; }
        #stats { font-size: 1.2rem; margin-top: 10px; }
        #game-container { position: relative; border: 4px solid #00ffff; box-shadow: 0 0 25px #00ffff, inset 0 0 15px #00ffff; width: 350px; height: 350px; background: black; }
        canvas { display: block; cursor: crosshair; }
        
        /* LEADERBOARD OVERLAY */
        #leaderboard-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .lb-content { width: 85%; }
        .lb-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 10px 0; font-size: 0.9rem; }
        .btn-share { width: 100%; padding: 15px; background: #00ffff; color: black; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px; font-family: inherit; }
    </style>
</head>
<body>

    <div id="ui">
        <h1>THE SYNC</h1>
        <div id="stats">SCORE: <span id="scoreVal">0</span> | TIME: <span id="timeVal">30</span></div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas" width="350" height="350"></canvas>
        <div id="leaderboard-modal">
            <div class="lb-content">
                <h2 style="color:#00ffff; margin-bottom:15px; letter-spacing:3px;">GLOBAL RANKS</h2>
                <div id="leaderboard-data" style="margin-bottom:20px;">Syncing scores...</div>
                <button id="share-rank-btn" class="btn-share">SHARE RANK TO FARCASTER</button>
                <button onclick="location.reload()" style="background:none; border:1px solid white; color:white; width:100%; padding:10px; margin-top:10px; border-radius:8px; cursor:pointer;">PLAY AGAIN</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let score = 0;
        let timeLeft = 30;
        let gameActive = true;

        const player = { x: 165, y: 165, size: 20 };
        const target = { x: 50, y: 50, size: 20 };

        function draw() {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // Neon Target
            ctx.shadowBlur = 15;
            ctx.shadowColor = "#00ffff";
            ctx.fillStyle = "#00ffff";
            ctx.fillRect(target.x, target.y, target.size, target.size);
            // Player Center
            ctx.shadowBlur = 0;
            ctx.fillStyle = "white";
            ctx.fillRect(player.x, player.y, player.size, player.size);
        }

        function handleInput() {
            if(!gameActive) return;
            score++;
            document.getElementById('scoreVal').innerText = score;
            target.x = Math.random() * (canvas.width - 25);
            target.y = Math.random() * (canvas.height - 25);
            draw();
        }

        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(); });

        const timer = setInterval(() => {
            if (timeLeft > 0) {
                timeLeft--;
                document.getElementById('timeVal').innerText = timeLeft;
            } else {
                clearInterval(timer);
                gameActive = false;
                showLeaderboard();
            }
        }, 1000);

        async function showLeaderboard() {
            document.getElementById('leaderboard-modal').style.display = 'flex';
            const username = "Player"; 

            try {
                // Post to your Vercel Redis
                await fetch('/api/score', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ username, score }) 
                });
                
                // Get the Ranks
                const res = await fetch('/api/score');
                const data = await res.json();
                
                let html = "";
                for (let i = 0; i < Math.min(data.length, 10); i += 2) {
                    html += `<div class="lb-row"><span>${(i/2)+1}. ${data[i]}</span><span>${data[i+1]}</span></div>`;
                }
                document.getElementById('leaderboard-data').innerHTML = html;

                // Share Link
                const shareUrl = `https://warpcast.com/~/compose?text=${encodeURIComponent("I hit " + score + " on THE SYNC! ⚡️")}&embeds[]=${window.location.href}`;
                document.getElementById('share-rank-btn').onclick = () => window.open(shareUrl, '_blank');
            } catch (e) { 
                document.getElementById('leaderboard-data').innerHTML = "Score Saved!";
            }
        }
        draw();
    </script>
</body>
</html>
