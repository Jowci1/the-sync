<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE SYNC V2</title>

    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://the-sync.vercel.app/icon.png" />
    <meta property="fc:frame:button:1" content="PLAY NOW" />
    <meta property="fc:frame:button:1:action" content="link" />
    <meta property="fc:frame:button:1:target" content="https://the-sync.vercel.app" />

    <style>
        body { margin: 0; background-color: black; color: #00ffff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; touch-action: none; }
        h1 { font-size: 2rem; text-shadow: 0 0 10px #0ff; margin: 0; }
        #game-container { position: relative; border: 4px solid #0ff; box-shadow: 0 0 20px #0ff; width: 300px; height: 300px; background: black; margin-top: 10px; }
        canvas { display: block; }
        #leaderboard-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn { width: 80%; padding: 10px; margin-top: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; border: none; }
    </style>
</head>
<body>
    <h1>THE SYNC</h1>
    <div id="stats">SCORE: <span id="scoreVal">0</span> | TIME: <span id="timeVal">30</span></div>
    <div id="game-container">
        <canvas id="gameCanvas" width="300" height="300"></canvas>
        <div id="leaderboard-modal">
            <h2 style="color:#0ff">RANKS</h2>
            <div id="leaderboard-data" style="font-size: 0.8rem; margin-bottom: 10px;">Syncing...</div>
            <button id="share-btn" class="btn" style="background:#0ff">SHARE TO FARCASTER</button>
            <button onclick="location.reload()" class="btn" style="background:white">RETRY</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let score = 0, timeLeft = 30, gameActive = true;
        const target = { x: 50, y: 50 };

        function draw() {
            ctx.fillStyle = "black"; ctx.fillRect(0,0,300,300);
            ctx.fillStyle = "#0ff"; ctx.shadowBlur = 10; ctx.shadowColor = "#0ff";
            ctx.fillRect(target.x, target.y, 20, 20);
        }

        function hit() {
            if(!gameActive) return;
            score++; document.getElementById('scoreVal').innerText = score;
            target.x = Math.random()*270; target.y = Math.random()*270; draw();
        }
        canvas.addEventListener('mousedown', hit);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); hit(); });

        const timer = setInterval(() => {
            if (timeLeft > 0) { timeLeft--; document.getElementById('timeVal').innerText = timeLeft; }
            else { clearInterval(timer); gameActive = false; showLB(); }
        }, 1000);

        async function showLB() {
            document.getElementById('leaderboard-modal').style.display = 'flex';
            try {
                await fetch('/api/score', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ username: "Player", score }) });
                const res = await fetch('/api/score');
                const data = await res.json();
                let html = "";
                for (let i = 0; i < Math.min(data.length, 10); i += 2) {
                    html += `<div style="display:flex; justify-content:space-between; width:80%; margin:auto;"><span>${data[i]}</span><span>${data[i+1]}</span></div>`;
                }
                document.getElementById('leaderboard-data').innerHTML = html;
                document.getElementById('share-btn').onclick = () => {
                    window.open(`https://warpcast.com/~/compose?text=${encodeURIComponent("Score: "+score)}&embeds[]=${window.location.href}`);
                };
            } catch (e) { console.log(e); }
        }
        draw();
    </script>
</body>
</html>
